import test from "ava";
import {
  Uint128,
  Uint128BE,
  HexUint128,
  HexUint128BE,
  Uint64,
  Uint64BE,
  HexUint64,
  HexUint64BE,
  Uint32LE,
  Uint32BE,
  HexUint32LE,
  HexUint32BE,
  Uint16LE,
  Uint16BE,
  HexUint16LE,
  HexUint16BE,
  Uint256,
  Uint256BE,
  HexUint256,
  HexUint256BE,
  Uint512,
  Uint512BE,
  HexUint512,
  HexUint512BE,
  Uint8,
  HexUint8,
  createByteCodec,
  HexBytes,
  fixedHexBytes,
  UTF8String,
} from "../src/common";
import { createBuffer } from "../src/utils";
import { BI } from "@ckb-lumos/bi";
import { BinaryCodec } from "../src/layout";

test("test Uint8", (t) => {
  const num = 18; // 0x12
  const numStr = "0x12"; // 0x12
  const packed = Uint8.pack(num);
  const strPacked = HexUint8.pack(numStr);
  t.deepEqual(packed, createBuffer([0x12]));
  t.truthy(num === Uint8.unpack(packed));
  t.truthy(numStr === HexUint8.unpack(strPacked));
});

test("test Uint16", (t) => {
  const num = 4660; // 0x1234
  const packed = Uint16LE.pack(num);
  const packedBE = Uint16BE.pack(num);
  t.deepEqual(packed, createBuffer([0x34, 0x12]));
  t.deepEqual(packedBE, createBuffer([0x12, 0x34]));
  t.truthy(num === Uint16LE.unpack(packed));
  t.truthy(num === Uint16BE.unpack(packedBE));
});

test("test Uint16 Hex", (t) => {
  const num = "0x1234";
  const packed = HexUint16LE.pack(num);
  const packedBE = HexUint16BE.pack(num);
  t.deepEqual(packed, createBuffer([0x34, 0x12]));
  t.deepEqual(packedBE, createBuffer([0x12, 0x34]));
  t.truthy(num === HexUint16LE.unpack(packed));
  t.truthy(num === HexUint16BE.unpack(packedBE));
});

test("test Uint32", (t) => {
  const num = 305419896; // 0x12345678
  const packed = Uint32LE.pack(num);
  const packedBE = Uint32BE.pack(num);
  t.deepEqual(packed, createBuffer([0x78, 0x56, 0x34, 0x12]));
  t.deepEqual(packedBE, createBuffer([0x12, 0x34, 0x56, 0x78]));
  t.truthy(num === Uint32LE.unpack(packed));
  t.truthy(num === Uint32BE.unpack(packedBE));
});

test("test Uint32 Hex", (t) => {
  const num = "0x12345678";
  const packed = HexUint32LE.pack(num);
  const packedBE = HexUint32BE.pack(num);
  t.deepEqual(packed, createBuffer([0x78, 0x56, 0x34, 0x12]));
  t.deepEqual(packedBE, createBuffer([0x12, 0x34, 0x56, 0x78]));
  t.truthy(num === HexUint32LE.unpack(packed));
  t.truthy(num === HexUint32BE.unpack(packedBE));
});

test("test Uint64", (t) => {
  const num = BI.from("0xf1f2f3f4f5f6f7f8");
  const packedBE = Uint64BE.pack(num);
  const packedLE = Uint64.pack(num);
  t.deepEqual(
    packedBE,
    // prettier-ignore
    createBuffer([ 0xf1, 0xf2, 0xf3, 0xf4, 0xf5, 0xf6, 0xf7, 0xf8 ])
  );
  t.deepEqual(
    packedLE,
    // prettier-ignore
    createBuffer([ 0xf8, 0xf7, 0xf6, 0xf5, 0xf4, 0xf3, 0xf2, 0xf1 ])
  );
  t.truthy(Uint64.unpack(packedLE).eq(num));
  t.truthy(Uint64BE.unpack(packedBE).eq(num));
});

test("test Uint64 hex", (t) => {
  const num = "0xf1f2f3f4f5f6f7f8";
  const packedBE = HexUint64BE.pack(num);
  const packedLE = HexUint64.pack(num);
  t.deepEqual(
    packedBE,
    createBuffer([0xf1, 0xf2, 0xf3, 0xf4, 0xf5, 0xf6, 0xf7, 0xf8])
  );
  t.deepEqual(
    packedLE,
    createBuffer([0xf8, 0xf7, 0xf6, 0xf5, 0xf4, 0xf3, 0xf2, 0xf1])
  );
  t.truthy(HexUint64.unpack(packedLE) === num);
  t.truthy(HexUint64BE.unpack(packedBE) === num);
});

test("test Uint128", (t) => {
  const num = BI.from("0xf1f2f3f4f5f6f7f8");
  const packedBE = Uint128BE.pack(num);
  const packedLE = Uint128.pack(num);
  t.deepEqual(
    packedBE,
    // prettier-ignore
    createBuffer([ 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0xf1, 0xf2, 0xf3, 0xf4, 0xf5, 0xf6, 0xf7, 0xf8 ])
  );
  t.deepEqual(
    packedLE,
    // prettier-ignore
    createBuffer([ 0xf8, 0xf7, 0xf6, 0xf5, 0xf4, 0xf3, 0xf2, 0xf1, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00 ])
  );
  t.truthy(Uint128.unpack(packedLE).eq(num));
  t.truthy(Uint128BE.unpack(packedBE).eq(num));
});

test("test Uint128 hex", (t) => {
  const num = "0xf1f2f3f4f5f6f7f8";
  const packedBE = HexUint128BE.pack(num);
  const packedLE = HexUint128.pack(num);
  t.deepEqual(
    packedBE,
    // prettier-ignore
    createBuffer([ 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0xf1, 0xf2, 0xf3, 0xf4, 0xf5, 0xf6, 0xf7, 0xf8 ])
  );
  t.deepEqual(
    packedLE,
    // prettier-ignore
    createBuffer([ 0xf8, 0xf7, 0xf6, 0xf5, 0xf4, 0xf3, 0xf2, 0xf1, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00 ])
  );
  t.truthy(HexUint128.unpack(packedLE) === num);
  t.truthy(HexUint128BE.unpack(packedBE) === num);
});

test("test Uint256", (t) => {
  const num = BI.from("0xf1f2f3f4f5f6f7f8");
  const packedBE = Uint256BE.pack(num);
  const packedLE = Uint256.pack(num);
  t.deepEqual(
    packedBE,
    // prettier-ignore
    createBuffer([ 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00,
       0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0xf1, 0xf2, 0xf3, 0xf4, 0xf5, 0xf6, 0xf7, 0xf8 ])
  );
  t.deepEqual(
    packedLE,
    // prettier-ignore
    createBuffer([ 0xf8, 0xf7, 0xf6, 0xf5, 0xf4, 0xf3, 0xf2, 0xf1, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00,
      0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00 ])
  );
  t.truthy(Uint256.unpack(packedLE).eq(num));
  t.truthy(Uint256BE.unpack(packedBE).eq(num));
});

test("test Uint256 hex", (t) => {
  const num = "0xf1f2f3f4f5f6f7f8";
  const packedBE = HexUint256BE.pack(num);
  const packedLE = HexUint256.pack(num);
  t.deepEqual(
    packedBE,
    // prettier-ignore
    createBuffer([ 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00,
       0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0xf1, 0xf2, 0xf3, 0xf4, 0xf5, 0xf6, 0xf7, 0xf8 ])
  );
  t.deepEqual(
    packedLE,
    // prettier-ignore
    createBuffer([ 0xf8, 0xf7, 0xf6, 0xf5, 0xf4, 0xf3, 0xf2, 0xf1, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00,
      0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00 ])
  );
  t.truthy(HexUint256.unpack(packedLE) === num);
  t.truthy(HexUint256BE.unpack(packedBE) === num);
});

test("test Uint512", (t) => {
  const num = BI.from("0xf1f2f3f4f5f6f7f8");
  const packedBE = Uint512BE.pack(num);
  const packedLE = Uint512.pack(num);
  t.deepEqual(
    packedBE,
    // prettier-ignore
    createBuffer([  0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00,
      0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00,
      0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00,
      0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0xf1, 0xf2, 0xf3, 0xf4, 0xf5, 0xf6, 0xf7, 0xf8 ])
  );
  t.deepEqual(
    packedLE,
    // prettier-ignore
    createBuffer([ 0xf8, 0xf7, 0xf6, 0xf5, 0xf4, 0xf3, 0xf2, 0xf1, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 
      0x0, 0x00, 0x00, 0x0, 0x0, 0x00,0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0,
      0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00,
      0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00 ])
  );
  t.truthy(Uint512.unpack(packedLE).eq(num));
  t.truthy(Uint512BE.unpack(packedBE).eq(num));
});

test("test Uint512 hex", (t) => {
  const num = "0xf1f2f3f4f5f6f7f8";
  const packedBE = HexUint512BE.pack(num);
  const packedLE = HexUint512.pack(num);
  t.deepEqual(
    packedBE,
    // prettier-ignore
    createBuffer([  0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00,
      0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00,
      0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00,
      0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0xf1, 0xf2, 0xf3, 0xf4, 0xf5, 0xf6, 0xf7, 0xf8 ])
  );
  t.deepEqual(
    packedLE,
    // prettier-ignore
    createBuffer([ 0xf8, 0xf7, 0xf6, 0xf5, 0xf4, 0xf3, 0xf2, 0xf1, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 
      0x0, 0x00, 0x00, 0x0, 0x0, 0x00,0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0,
      0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00,
      0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00, 0x00, 0x0, 0x0, 0x00 ])
  );
  t.truthy(HexUint512.unpack(packedLE) === num);
  t.truthy(HexUint512BE.unpack(packedBE) === num);
});

test("test createByteCodec", (t) => {
  const userCodec: BinaryCodec<string> = {
    pack: (value) => {
      return Buffer.from(value.toString());
    },
    unpack: (buffer) => {
      return buffer.toString();
    },
  };
  const itemCodec = createByteCodec(userCodec);
  t.truthy(itemCodec === userCodec);
});

test("test hex bytes", (t) => {
  const hexStr = "0x123456"
  const hexBytes = HexBytes.pack(hexStr);
  t.deepEqual(
    hexBytes,
    // prettier-ignore
    createBuffer([ 0x12, 0x34, 0x56 ])
  );
  t.truthy(hexStr === HexBytes.unpack(hexBytes));
});
test("test fixed hex bytes", (t) => {
  const hexStr = "0x123456"
  const hexBytes = fixedHexBytes(3).pack(hexStr);
  t.deepEqual(
    hexBytes,
    // prettier-ignore
    createBuffer([ 0x12, 0x34, 0x56 ])
  );
  t.truthy(hexStr === fixedHexBytes(3).unpack(hexBytes));
});
test("test UTF8String", (t) => {
  const hexStr = "0x123456"
  const hexBytes = UTF8String.pack(hexStr);
  t.deepEqual(
    hexBytes,
    // prettier-ignore
    createBuffer([ 0x12, 0x34, 0x56 ])
  );
  t.truthy(hexStr === UTF8String.unpack(hexBytes));
});
