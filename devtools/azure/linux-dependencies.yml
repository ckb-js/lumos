parameters:
  rustup_toolchain: ""
  node_version: ""
steps:
  - script: |
      sudo apt install -y build-essential
  - script: |
      curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain ${{ parameters.rustup_toolchain }}
      set PATH=$PATH:~/.cargo/bin
    displayName: Install rust
  - script: |
      rustc --version
      cargo --version
    displayName: Test/query binaries
  - script: |
      pwd
      curl -O -L "https://github.com/nervosnetwork/ckb-indexer/releases/download/v0.2.2/ckb-indexer-0.2.2-linux.zip"
      unzip -o ckb-indexer-0.2.2-linux.zip
      tar xvzf ckb-indexer-linux-x86_64.tar.gz ckb-indexer
      chmod +x ./ckb-indexer
      rm -rf ckb-indexer-linux-x86_64.tar.gz
      rm ckb-indexer-0.2.2-linux.zip
    displayName: install indexer
  - script: |
      nohup ./ckb-indexer -c http://127.0.0.1:8118/rpc -l 127.0.0.1:8119 -s indexer-store-tmp &
    displayName: run ckb indexer
  - task: NodeTool@0
    inputs:
      versionSpec: ${{ parameters.node_version }}
    displayName: "Install Node.js"
